# HTTP 的缺点

HTTP 主要不足：

-  通信使用明文（不加密），内容可能会被窃听
- 不验证通信方的身份，因此有可能遭遇伪装
- 无法证明报文的完整性，所以有可能已遭篡改

## 通信使用明文可能会被窃听  

互联网上的任何角落都存在通信内容被窃听的风险：

![](./img/wiretap.png)

防止窃听保护信息的几种对策中，最为普及的就是加密技术。加密的对象可以有：

- 通信的加密
- 内容的加密

### 通信的加密

HTTP 协议中没有加密机制，但可以通过和 SSL（ Secure Socket Layer，安全套接层）或 TLS（ Transport Layer Security，安全层传输协议）的组合使用，加密 HTTP 的通信内容。  

用 SSL 建立安全通信线路之后，就可以在这条线路上进行 HTTP 通信了。与 SSL 组合使用的 HTTP 被称为 HTTPS（ HTTP Secure，超文本传输安全协议）或 HTTP over SSL。  

![](./img/http_over_ssl.png)

### 内容的加密

即把 HTTP 报文里所含的内容进行加密处理。  

![](./img/encryped_content.png)

为了做到有效的内容加密，前提是要求客户端和服务器同时具备加密和解密机制。 主要应用在 Web 服务中。有一点必须引起注意，由于该方式不同于 SSL 或 TLS 将整个通信线路加密处理，所以内容仍有被篡改的风险。  

## 不验证通信方的身份就可能遭遇伪装  

HTTP 协议中的请求和响应不会对通信方进行确认。也就是说存在“服务器是否就是发送请求中 URI 真正指定的主机，返回的响应是否真的返回到实际提出请求的客户端”等类似问题。  

### 任何人都可发起请求  

在 HTTP 协议通信时，由于不存在确认通信方的处理步骤，任何人都可以发起请求。 另外，服务器只要接收到请求，不管对方是谁都会返回一个响应（但也仅限于发送端的 IP 地址和端口号没有被 Web 服务器设定限制访问的前提下）。  

![](./img/anyone_request.png)

- 无法确定请求发送至目标的 Web 服务器是否是按真实意图返回响应的那台服务器。有可能是已伪装的 Web 服务器
- 无法确定响应返回到的客户端是否是按真实意图接收响应的那个客户端。有可能是已伪装的客户端
- 无法确定正在通信的对方是否具备访问权限。因为某些 Web 服务器上保存着重要的信息，只想发给特定用户通信的权限  
- 无法判定请求是来自何方、出自谁手
- 即使是无意义的请求也会照单全收。无法阻止海量请求下的 DoS 攻击（Denial of Service，拒绝服务攻击）  

### 查明对手的证书

虽然使用 HTTP 协议无法确定通信方，但如果使用 SSL 则可以。SSL 不仅提供加密处理， 而且还使用了一种被称为证书的手段，可用于确定方。  

证书由值得信任的第三方机构颁发， 用以证明服务器和客户端是实际存在的。  

![](./img/certificate.png)

## 无法证明报文完整性，可能已遭篡改  

所谓完整性是指信息的准确度。若无法证明其完整性，通常也就意味着无法判断信息是否准确。  

### 接收到的内容可能有误  

没有任何办法确认，发出的请求/响应和接收到的请求/响应是前后相同的。  

![](./img/changed.png)

像这样，请求或响应在传输途中，遭攻击者拦截并篡改内容的攻击称为中间人攻击（ Man-in-the-Middle attack， MITM）。  

![](./img/mitm.png)

### 如何防止篡改  

虽然有使用 HTTP 协议确定报文完整性的方法，但并不便捷、可靠。其中常用的是 MD5 和 SHA-1 等散列值校验的方法，以及用来确认文件的数字签名方法。  

# HTTP+ 加密 + 认证 + 完整性保护 =HTTPS  

## HTTP 加上加密处理和认证以及完整性保护后即是 HTTPS  

把添加了加密及认证机制的 HTTP 称为 HTTPS（ HTTP Secure）。  

![](./img/http_secure.png)

## HTTPS 是身披 SSL 外壳的 HTTP  

HTTPS 并非是应用层的一种新协议。只是 HTTP 通信接口部分用 SSL（ Secure Socket Layer）和 TLS（ Transport Layer Security）协议代替而已。  

![](./img/https.png)

在采用 SSL 后， HTTP 就拥有了 HTTPS 的加密、证书和完整性保护这些功能。  

SSL 是独立于 HTTP 的协议，所以不光是 HTTP 协议，其他运行在应用层的 SMTP 和 Telnet 等协议均可配合 SSL 协议使用。  

## 相互交换密钥的公开密钥加密技术

SSL 采用一种叫做公开密钥加密（ Public-key cryptography）的加密处理方式。近代的加密方法中加密算法是公开的， 而密钥却是保密的。通过这
种方式得以保持加密方法的安全性。

加密和解密都会用到密钥。 没有密钥就无法对密码解密，反过来说，任何人只要持有密钥就能解密了。 如果密钥被攻击者获得，那加密也就失去了意义。  

### 共享密钥加密的困境  

加密和解密同用一个密钥的方式称为共享密钥加密（ Common key crypto system），也被叫做对称密钥加密。  

以共享密钥方式加密时必须将密钥也发给对方。  在互联网上转发密钥时，如果通信被监听那么密钥就可会落入攻击者之手， 同时也就失去了加密的意义。另外还得设法安全地保管接收到的密钥。  

![](./img/symmetric_encryption.png)

### 使用两把密钥的公开密钥加密  











# 为什么要有HTTPS？

“因为HTTP不安全”。由于HTTP天生“明文”的特点，整个传输过程完全透明，任何人都能够在链路中截获、修改或者伪造请求/响应报文，数据不具有可信性。

# 什么是安全？

通常认为，如果通信过程具备了四个特性，就可以认为是“安全”的，这四个特性是：机密性、完整性，身份认证和不可否认。

## 机密性

机密性（Secrecy/Confidentiality）是指对数据的“保密”，只能由可信的人访问，对其他人是不可见的“秘密”，简单来说就是不能让不相关的人看到不该看的东西。

## 完整性

完整性（Integrity，也叫一致性）是指数据在传输过程中没有被窜改，不多也不少，“完完整整”地保持着原状。

## 身份认证

身份认证（Authentication）是指确认对方的真实身份，也就是“证明你真的是你”，保证消息只能发送给可信的人。

## 不可否认

不可否认（Non-repudiation/Undeniable），也叫不可抵赖，意思是不能否认已经发生过的行为，不能“说话不算数”“耍赖皮”。

# 什么是HTTPS？

HTTPS 默认端口号443，至于其他的什么请求-应答模式、报文结构、请求方法、URI、头字段、连接管理等等都完全沿用HTTP，没有任何新的东西。也就是说，除了协议名“http”和端口号80这两点不同，HTTPS协议在语法、语义上和HTTP完全一样，优缺点也“照单全收”（当然要除去“明文”和“不安全”）。

HTTPS  将 HTTP 下层的传输协议由TCP/IP换成了SSL/TLS，由“**HTTP over TCP/IP**”变成了“**HTTP over SSL/TLS**”，让HTTP运行在了安全的SSL/TLS协议上，收发报文不再使用Socket API，而是调用专门的安全接口。

![](./img/https.png)

# SSL/TLS

SSL即安全套接层（Secure Sockets Layer），在OSI模型中处于第5层（会话层），由网景公司于1994年发明，有v2和v3两个版本，而v1因为有严重的缺陷从未公开过。

SSL发展到v3时已经证明了它自身是一个非常好的安全通信协议，于是互联网工程组IETF在1999年把它改名为TLS（传输层安全，Transport Layer Security），正式标准化，版本号从1.0重新算起，所以TLS1.0实际上就是SSLv3.1。

目前应用的最广泛的TLS是1.2，而之前的协议（TLS1.1/1.0、SSLv3/v2）都已经被认为是不安全的，各大浏览器即将在2020年左右停止支持。

TLS由记录协议、握手协议、警告协议、变更密码规范协议、扩展协议等几个子协议组成，综合使用了对称加密、非对称加密、身份认证等许多密码学前沿技术。

# OpenSSL

说到TLS，就不能不谈到OpenSSL，它是一个著名的开源密码学程序库和工具包，几乎支持所有公开的加密算法和协议，已经成为了事实上的标准，许多应用软件都会使用它作为底层库来实现TLS功能，包括常用的Web服务器Apache、Nginx等。





